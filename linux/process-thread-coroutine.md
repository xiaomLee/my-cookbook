# 进程 线程 协程

经典的冯诺依曼结构把计算机系统抽象成 CPU + 存储器 + IO，那么计算机资源无非就两种：

1. 计算资源
2. 存储资源

CPU是计算单元，单纯从CPU的角度来说它是一个黑盒，它只对输入的指令和数据进行计算，然后输出结果，它不负责管理计算哪些“指令和数据”。 换句话说CPU只提供了计算能力，但是不负责分配计算资源。

进程是线程的基础，进程负责的是存储资源的分配；线程是为计算资源的分配而设计的，也即是为调度器而服务的。
内核通过内核调度实体(Kernal Scheduling Entry， KSE)来进行调度。于Linux内核而言进程，线程并无太大区别，每个进程创建后会默认创建一个thread0。

## 概念

### 进程

进程是操作系统分配存储资源的最小单位。

1. 每个进程拥有独立的虚拟地址空间：虚拟地址空间分内核空间于用户空间，32位操作系统下，内核空间拥有1G 用户空间3G
2. 内空间存储内核代码、数据，以及与进程相关的数据结构(例如：Task、页表、内核栈、文件描述符等)；内核代码、数据所有进程共享
3. 用户空间存储用户代码数据，用户栈，运行时堆等数据；进程独有
4. 所有虚拟地址最终通过页表进行映射，关联实际物理存储
5. 进程间通信只能通过信号、信号量、管道、socket等技术，无法共享内存

### 线程

线程是操作系统调度的最小单位。

Linux中线程的创建通过clone系统调用，clone是一个轻量级的fork，它提供了一系列的参数来表示线程可以共享父类的哪些资源，比如页表，打开文件表等等。

1. 所有子线程共享进程的虚拟地址空间
2. 每个线程有自身的栈空间、程序计数器
3. 线程间通信基于共享内存

### 协程

协程可以看做是编程语言在用户态提供的线程，一种粒度更细的资源调度单元。

- 协程的调度理想状态下不涉及内核态的切换，可以近似抽象的认为线程在占用一个CPU时间片内，调度执行多个不同的用户逻辑块
- 协程就是这些逻辑块的封装，操作系统不实现，需由编程语言自身运行时或者共享库来实现。C语系下有Coroutine, Goroutine
- 从协程的实现原理来看，协程适用于IO密集型场景——即在每次遇到IO阻塞时就去调度下一个用户代码块(协程)，最大限度压榨cpu，同时尽量减少线程切换
- 协程是用户态的实现，有自身的运行栈、以及状态信息，总体来说运行时的状态信息大小比线程小很多 go里面初始大小为2kb Linux线程块大小通常在1m

## 多任务切换

### 多进程

多进程的CPU切换流程
1. 发生中断或系统调用，进入内核态执行进程上下文保存：寄存器信息入内核栈
2. 内核栈的保存：将进程相关的内核栈信息保存在内核空间与进程对应的PCB结构中(包括寄存器、Task、页表、内核栈、文件描述符等)
3. 加载将要被调度的进程信息，切换页表
4. PC寄存器更新为目标进程的内核栈
5. 执行目标进程的内核栈，恢复寄存器状态，切换回用户态进程

涉及的上下文资源

1. 寄存器信息
2. 页表、文件描述符等
3. 进程运行状态等信息

地址空间(页表)的切换消耗大，通常32寻址空间一级页表的就有4M。目前64位操作系统下通常采用48位的寻址空间，四级页表结构：9+9+9+9+12的寻址方式。

### 多线程

Linux下多线程切换流程与多进程类似，当目标线程与当前线程同属一个进程时，不涉及页表切换，只涉及内核栈与寄存器信息的切换。通常一个线程会占用大概1M以上的内存空间。

上下文资源
1. 寄存器信息：栈寄存器、程序计数器
2. 线程运行状态

### 协程

- 协程可以看做是编程语言在用户态提供的线程，一种粒度更细的资源调度单元，进一步压榨cpu
- 协程的调度理想状态下不涉及内核态的切换，可以近似抽象的认为线程在占用一个CPU时间片内，调度执行多个不同的用户逻辑块
- 协程就是这些逻辑块的封装，操作系统不实现，需由编程语言自身运行时或者共享库来实现。C语系下有Coroutine, Goroutine
- 从协程的实现原理来看，协程适用于IO密集型场景——即在每次遇到IO阻塞时就去调度下一个用户代码块(协程)，最大限度压榨cpu，同时尽量减少线程切换
- 协程是用户态的实现，有自身的运行栈、以及状态信息，总体来说运行时的状态信息大小比线程小很多 go里面初始大小为2kb Linux线程块大小通常在1m



https://aijishu.com/a/1060000000293144
https://ost.51cto.com/posts/659
https://www.eet-china.com/mp/a92885.html
https://blog.csdn.net/gong_1/article/details/18405153